#!/bin/bash
echo "Seting variables"
RELEASE=focal
JETSON_NAME=jetski
JETSON_USR=alistair
JETSON_PWD=password
JETSON_BOARD=jetson-nano
JETSON_BOARD_REV=300
BSP_URL=https://developer.nvidia.com/embedded/l4t/r32_release_v7.2/t210/jetson-210_linux_r32.7.2_aarch64.tbz2

echo "Installing dependencies"
sudo apt-get -y install debootstrap qemu-user-static binfmt-support libxml2-utils


echo "Downloading BSP"
wget -qO jetson_bsp.tbz2 ${BSP_URL}


echo "Extracting BSP"
tar -jpxf jetson_bsp.tbz2
rm jetson_bsp.tbz2
cd Linux_for_Tegra/rootfs


echo "Starting debootstrap"
debootstrap --variant=minbase --arch=arm64 --foreign ${RELEASE} . # add --variant=minbase later
cp /usr/bin/qemu-aarch64-static usr/bin/


echo "Mounting rootfs"
mount /sys ./sys -o bind
mount /proc ./proc -o bind
mount /dev ./dev -o bind
mount /dev/pts ./dev/pts -o bind


echo "Finishing debootstrap"
chroot . /debootstrap/debootstrap --second-stage


echo "Setting repos"
echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports ${RELEASE} main restricted universe multiverse
deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports ${RELEASE}-updates main restricted universe multiverse
deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports ${RELEASE}-security main restricted universe multiverse
deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports ${RELEASE}-backports main restricted universe multiverse" | tee etc/apt/sources.list


echo "Installing packages"
chroot . apt-get update
# echo apt-get -y install $(cut -d"=" -f1  ../tools/samplefs/nvubuntu-bionic-aarch64-packages | xargs) | DEBIAN_FRONTEND=noninteractive chroot .
chroot . apt-get -y install adduser adwaita-icon-theme alsa-ucm-conf alsa-utils apport apport-symptoms apt base-files base-passwd bash bc binfmt-support binutils binutils-aarch64-linux-gnu binutils-common:arm64 bluez bridge-utils bsdmainutils bsdutils bubblewrap bzip2 ca-certificates ca-certificates-mono can-utils cli-common console-setup console-setup-linux coreutils cpp cpp-9 cryptsetup cryptsetup-bin dash dbus dbus-user-session dbus-x11 dconf-gsettings-backend:arm64 dconf-service debconf debianutils device-tree-compiler diffutils dirmngr distro-info-data dmsetup dpkg e2fsprogs fdisk file findutils fio fontconfig fontconfig-config fonts-dejavu-core freeglut3:arm64 fuse gcc-10-base:arm64 gcc-9-base:arm64 gdal-data gdbserver gdisk gir1.2-glib-2.0:arm64 gir1.2-gst-plugins-bad-1.0:arm64 gir1.2-gst-plugins-base-1.0:arm64 gir1.2-gstreamer-1.0:arm64 glib-networking:arm64 glib-networking-common glib-networking-services gnupg gnupg-l10n gnupg-utils gnupg2 gpg gpg-agent gpg-wks-client gpg-wks-server gpgconf gpgsm gpgv grep groff-base gsettings-desktop-schemas gstreamer1.0-alsa:arm64 gstreamer1.0-libav:arm64 gstreamer1.0-plugins-bad:arm64 gstreamer1.0-plugins-base:arm64 gstreamer1.0-plugins-good:arm64 gstreamer1.0-plugins-ugly:arm64 gstreamer1.0-tools gstreamer1.0-x:arm64 gtk-update-icon-cache gzip haveged hicolor-icon-theme hostname humanity-icon-theme i2c-tools init-system-helpers iproute2 iptables iputils-ping isc-dhcp-client isc-dhcp-server iso-codes iw kbd kexec-tools keyboard-configuration kmod language-pack-en language-pack-en-base less liba52-0.7.4:arm64 libaa1:arm64 libacl1:arm64 libaec0:arm64 libaio1:arm64 libaom0:arm64 libapparmor1:arm64 libapt-pkg6.0:arm64 libarchive13:arm64 libargon2-1:arm64 libarmadillo9 libarpack2:arm64 libasn1-8-heimdal:arm64 libasound2:arm64 libasound2-data libass9:arm64 libassuan0:arm64 libasyncns0:arm64 libatk-bridge2.0-0:arm64 libatk1.0-0:arm64 libatk1.0-data libatopology2:arm64 libatspi2.0-0:arm64 libattr1:arm64 libaudit-common libaudit1:arm64 libavahi-client3:arm64 libavahi-common-data:arm64 libavahi-common3:arm64 libavc1394-0:arm64 libavcodec-dev:arm64 libavcodec58:arm64 libavfilter7:arm64 libavformat-dev:arm64 libavformat58:arm64 libavresample-dev:arm64 libavresample4:arm64 libavutil-dev:arm64 libavutil56:arm64 libbinutils:arm64 libblas3:arm64 libblkid-dev:arm64 libblkid1:arm64 libbluray2:arm64 libboost-iostreams1.71.0:arm64 libboost-thread1.71.0:arm64 libbrotli1:arm64 libbs2b0:arm64 libbsd0:arm64 libbz2-1.0:arm64 libc-bin libc-dev-bin libc6:arm64 libc6-dev:arm64 libcaca0:arm64 libcairo-gobject2:arm64 libcairo2:arm64 libcanberra0:arm64 libcap-ng0:arm64 libcap2:arm64 libcap2-bin libcbor0.6:arm64 libcdio18:arm64 libcdparanoia0:arm64 libcfitsio8:arm64 libcharls2:arm64 libchromaprint1:arm64 libcodec2-0.9:arm64 libcolord2:arm64 libcom-err2:arm64 libcrypt-dev:arm64 libcrypt1:arm64 libcryptsetup12:arm64 libctf-nobfd0:arm64 libctf0:arm64 libcups2:arm64 libcurl3-gnutls:arm64 libdap25:arm64 libdapclient6v5:arm64 libdatrie1:arm64 libdb5.3:arm64 libdbus-1-3:arm64 libdc1394-22:arm64 libdc1394-22-dev:arm64 libdca0:arm64 libdconf1:arm64 libde265-0:arm64 libdebconfclient0:arm64 libdevmapper1.02.1:arm64 libdns-export1109 libdpkg-perl libdrm-amdgpu1:arm64 libdrm-common libdrm-dev:arm64 libdrm-etnaviv1:arm64 libdrm-freedreno1:arm64 libdrm-nouveau2:arm64 libdrm-radeon1:arm64 libdrm-tegra0:arm64 libdrm2:arm64 libdv4:arm64 libdvdnav4:arm64 libdvdread7:arm64 libedit2:arm64 libegl-dev:arm64 libegl-mesa0:arm64 libegl1:arm64 libegl1-mesa:arm64 libegl1-mesa-dev:arm64 libelf1:arm64 libepoxy0:arm64 libepsilon1:arm64 libestr0:arm64 libevdev2:arm64 libevent-2.1-7:arm64 libevent-core-2.1-7:arm64 libevent-pthreads-2.1-7:arm64 libexif-dev:arm64 libexif12:arm64 libexpat1:arm64 libext2fs2:arm64 libfaad2:arm64 libfastjson4:arm64 libfdisk1:arm64 libfdt1:arm64 libffi-dev:arm64 libffi7:arm64 libfftw3-double3:arm64 libfftw3-single3:arm64 libfido2-1:arm64 libflac8:arm64 libflite1:arm64 libfluidsynth2:arm64 libfontconfig1:arm64 libfontenc1:arm64 libfreetype6:arm64 libfreexl1:arm64 libfribidi0:arm64 libfuse2:arm64 libfyba0:arm64 libgbm1:arm64 libgcc-s1:arm64 libgcc1 libgcrypt20:arm64 libgd3:arm64 libgdal26 libgdbm-compat4:arm64 libgdbm6:arm64 libgdcm-dev libgdcm3.0:arm64 libgdk-pixbuf2.0-0:arm64 libgdk-pixbuf2.0-common libgeos-3.8.0:arm64 libgeos-c1v5:arm64 libgeotiff5:arm64 libgfapi0:arm64 libgfortran5:arm64 libgfrpc0:arm64 libgfxdr0:arm64 libgif7:arm64 libgirepository-1.0-1:arm64 libgl-dev:arm64 libgl1:arm64 libgl1-mesa-dev:arm64 libgl1-mesa-dri:arm64 libgl2ps1.4 libglapi-mesa:arm64 libgles-dev:arm64 libgles1:arm64 libgles2:arm64 libgles2-mesa:arm64 libgles2-mesa-dev:arm64 libglib2.0-0:arm64 libglib2.0-bin libglib2.0-cil libglib2.0-cil-dev libglib2.0-data libglib2.0-dev:arm64 libglib2.0-dev-bin libglib2.0-doc libglib2.0-tests libglu1-mesa:arm64 libglusterfs0:arm64 libglvnd-dev:arm64 libglvnd0:arm64 libglx-dev:arm64 libglx-mesa0:arm64 libglx0:arm64 libgme0:arm64 libgmp10:arm64 libgnutls30:arm64 libgomp1:arm64 libgpg-error0:arm64 libgphoto2-6:arm64 libgphoto2-dev:arm64 libgphoto2-port12:arm64 libgpm2:arm64 libgraphite2-3:arm64 libgsm1:arm64 libgssapi-krb5-2:arm64 libgssapi3-heimdal:arm64 libgssdp-1.2-0:arm64 libgstreamer-gl1.0-0:arm64 libgstreamer-opencv1.0-0:arm64 libgstreamer-plugins-bad1.0-0:arm64 libgstreamer-plugins-bad1.0-dev:arm64 libgstreamer-plugins-base1.0-0:arm64 libgstreamer-plugins-base1.0-dev:arm64 libgstreamer-plugins-good1.0-0:arm64 libgstreamer-plugins-good1.0-dev libgstreamer1.0-0:arm64 libgstreamer1.0-0-dbg:arm64 libgstreamer1.0-dev:arm64 libgtk-3-0:arm64 libgtk-3-common libgudev-1.0-0:arm64 libgupnp-1.2-0:arm64 libgupnp-igd-1.0-4:arm64 libharfbuzz0b:arm64 libhavege1:arm64 libhcrypto4-heimdal:arm64 libhdf4-0-alt libhdf5-103:arm64 libhdf5-openmpi-103:arm64 libheimbase1-heimdal:arm64 libheimntlm0-heimdal:arm64 libhogweed5:arm64 libhwloc-plugins:arm64 libhwloc15:arm64 libhx509-5-heimdal:arm64 libi2c0:arm64 libibverbs1:arm64 libice6:arm64 libicu66:arm64 libidn2-0:arm64 libiec61883-0:arm64 libilmbase-dev:arm64 libilmbase24:arm64 libinput-bin libinput10:arm64 libinstpatch-1.0-2:arm64 libip4tc2:arm64 libip6tc2:arm64 libirs-export161 libisc-export1105:arm64 libisccfg-export163 libisl22:arm64 libiw30:arm64 libjack-jackd2-0:arm64 libjansson4:arm64 libjbig-dev:arm64 libjbig0:arm64 libjpeg-dev:arm64 libjpeg-turbo8:arm64 libjpeg-turbo8-dev:arm64 libjpeg8:arm64 libjpeg8-dev:arm64 libjs-jquery libjs-sphinxdoc libjs-underscore libjson-c4:arm64 libjson-glib-1.0-0:arm64 libjson-glib-1.0-common libjsoncpp1:arm64 libk5crypto3:arm64 libkate1:arm64 libkeyutils1:arm64 libkmlbase1:arm64 libkmldom1:arm64 libkmlengine1:arm64 libkmod2:arm64 libkrb5-26-heimdal:arm64 libkrb5-3:arm64 libkrb5support0:arm64 libksba8:arm64 liblapack3:arm64 liblcms2-2:arm64 libldap-2.4-2:arm64 libldap-common liblept5:arm64 liblilv-0-0:arm64 libllvm12:arm64 liblocale-gettext-perl libltdl7:arm64 liblz4-1:arm64 liblzma-dev:arm64 liblzma5:arm64 liblzo2-2:arm64 libmagic-mgc libmagic1:arm64 libminizip1:arm64 libmjpegutils-2.1-0:arm64 libmms0:arm64 libmnl0:arm64 libmodplug1:arm64 libmono-btls-interface4.0-cil libmono-corlib4.5-cil libmono-i18n-west4.0-cil libmono-i18n4.0-cil libmono-security4.0-cil libmono-system-configuration4.0-cil libmono-system-core4.0-cil libmono-system-numerics4.0-cil libmono-system-security4.0-cil libmono-system-xml4.0-cil libmono-system4.0-cil libmount-dev:arm64 libmount1:arm64 libmp3lame0:arm64 libmpc3:arm64 libmpcdec6:arm64 libmpdec2:arm64 libmpeg2-4:arm64 libmpeg2encpp-2.1-0:arm64 libmpfr6:arm64 libmpg123-0:arm64 libmplex2-2.1-0:arm64 libmtdev1:arm64 libmysofa1:arm64 libmysqlclient21:arm64 libncurses5:arm64 libncurses6:arm64 libncursesw6:arm64 libnetcdf-c++4 libnetcdf15:arm64 libnetfilter-conntrack3:arm64 libnettle7:arm64 libnfnetlink0:arm64 libnftnl11:arm64 libnghttp2-14:arm64 libnice10:arm64 libnl-3-200:arm64 libnl-genl-3-200:arm64 libnl-route-3-200:arm64 libnorm1:arm64 libnpth0:arm64 libnspr4:arm64 libnss-systemd:arm64 libnss3:arm64 libnuma1:arm64 libodbc1:arm64 libofa0:arm64 libogdi4.1 libogg0:arm64 libopenal-data libopenal1:arm64 libopencore-amrnb0:arm64 libopencore-amrwb0:arm64 libopencv-calib3d-dev:arm64 libopencv-calib3d4.2:arm64 libopencv-contrib-dev:arm64 libopencv-contrib4.2:arm64 libopencv-core-dev:arm64 libopencv-core4.2:arm64 libopencv-dev libopencv-dnn-dev:arm64 libopencv-dnn4.2:arm64 libopencv-features2d-dev:arm64 libopencv-features2d4.2:arm64 libopencv-flann-dev:arm64 libopencv-flann4.2:arm64 libopencv-highgui-dev:arm64 libopencv-highgui4.2:arm64 libopencv-imgcodecs-dev:arm64 libopencv-imgcodecs4.2:arm64 libopencv-imgproc-dev:arm64 libopencv-imgproc4.2:arm64 libopencv-ml-dev:arm64 libopencv-ml4.2:arm64 libopencv-objdetect-dev:arm64 libopencv-objdetect4.2:arm64 libopencv-photo-dev:arm64 libopencv-photo4.2:arm64 libopencv-shape-dev:arm64 libopencv-shape4.2:arm64 libopencv-stitching-dev:arm64 libopencv-stitching4.2:arm64 libopencv-superres-dev:arm64 libopencv-superres4.2:arm64 libopencv-ts-dev:arm64 libopencv-video-dev:arm64 libopencv-video4.2:arm64 libopencv-videoio-dev:arm64 libopencv-videoio4.2:arm64 libopencv-videostab-dev:arm64 libopencv-videostab4.2:arm64 libopencv-viz-dev:arm64 libopencv-viz4.2:arm64 libopencv4.2-java libopencv4.2-jni libopenexr-dev libopenexr24:arm64 libopengl-dev:arm64 libopengl0:arm64 libopenjp2-7:arm64 libopenmpi3:arm64 libopenmpt0:arm64 libopus0:arm64 liborc-0.4-0:arm64 liborc-0.4-dev:arm64 liborc-0.4-dev-bin libp11-kit0:arm64 libpam-modules:arm64 libpam-modules-bin libpam-runtime libpam-systemd:arm64 libpam0g:arm64 libpango-1.0-0:arm64 libpangocairo-1.0-0:arm64 libpangoft2-1.0-0:arm64 libparted2:arm64 libpcap0.8:arm64 libpci3:arm64 libpciaccess0:arm64 libpcre16-3:arm64 libpcre2-16-0:arm64 libpcre2-32-0:arm64 libpcre2-8-0:arm64 libpcre2-dev:arm64 libpcre2-posix2:arm64 libpcre3:arm64 libpcre3-dev:arm64 libpcre32-3:arm64 libpcrecpp0v5:arm64 libpcsclite1:arm64 libperl5.30:arm64 libpgm-5.2-0:arm64 libpipeline1:arm64 libpixman-1-0:arm64 libpixman-1-dev:arm64 libpmix2:arm64 libpng-dev:arm64 libpng16-16:arm64 libpoppler97:arm64 libpopt0:arm64 libpostproc55:arm64 libpq5:arm64 libprocps8:arm64 libproj15:arm64 libprotobuf17:arm64 libproxy1v5:arm64 libpsl5:arm64 libpthread-stubs0-dev:arm64 libpulse0:arm64 libpython2-stdlib:arm64 libpython2.7:arm64 libpython2.7-minimal:arm64 libpython2.7-stdlib:arm64 libpython3-stdlib:arm64 libpython3.8:arm64 libpython3.8-minimal:arm64 libpython3.8-stdlib:arm64 libqhull7:arm64 librados2 libraw1394-11:arm64 libraw1394-dev:arm64 librbd1 librdkafka1:arm64 librdmacm1:arm64 libreadline8:arm64 librest-0.7-0:arm64 libroken18-heimdal:arm64 librsvg2-2:arm64 librsvg2-common:arm64 librtmp1:arm64 librubberband2:arm64 libsamplerate0:arm64 libsasl2-2:arm64 libsasl2-modules-db:arm64 libsbc1:arm64 libsdl2-2.0-0:arm64 libseccomp2:arm64 libselinux1:arm64 libselinux1-dev:arm64 libsemanage-common libsemanage1:arm64 libsensors-config libsensors5:arm64 libsepol1:arm64 libsepol1-dev:arm64 libserd-0-0:arm64 libshine3:arm64 libshout3:arm64 libsidplay1v5:arm64 libslang2:arm64 libsm6:arm64 libsmartcols1:arm64 libsnappy1v5:arm64 libsndfile1:arm64 libsndio7.0:arm64 libsocket++1:arm64 libsodium23:arm64 libsord-0-0:arm64 libsoundtouch1:arm64 libsoup-gnome2.4-1:arm64 libsoup2.4-1:arm64 libsox-fmt-alsa:arm64 libsox-fmt-base:arm64 libsox3:arm64 libsoxr0:arm64 libspandsp2:arm64 libspatialite7:arm64 libspeex1:arm64 libsqlite3-0:arm64 libsratom-0-0:arm64 libsrt1:arm64 libsrtp2-1:arm64 libss2:arm64 libssh-4:arm64 libssh-gcrypt-4:arm64 libssl1.1:arm64 libstdc++6:arm64 libsuperlu5:arm64 libswresample-dev:arm64 libswresample3:arm64 libswscale-dev:arm64 libswscale5:arm64 libsystemd0:arm64 libsz2:arm64 libtag1v5:arm64 libtag1v5-vanilla:arm64 libtasn1-6:arm64 libtbb-dev:arm64 libtbb2:arm64 libtdb1:arm64 libtesseract4:arm64 libthai-data libthai0:arm64 libtheora0:arm64 libtiff-dev:arm64 libtiff5:arm64 libtiffxx5:arm64 libtinfo5:arm64 libtinfo6:arm64 libtirpc-common libtirpc3:arm64 libtwolame0:arm64 libuchardet0:arm64 libudev1:arm64 libunistring2:arm64 libunwind8:arm64 liburiparser1:arm64 libusb-1.0-0:arm64 libusrsctp1:arm64 libutempter0:arm64 libuuid1:arm64 libv4l-0:arm64 libv4lconvert0:arm64 libva-drm2:arm64 libva-x11-2:arm64 libva2:arm64 libvdpau1:arm64 libvidstab1.1:arm64 libvisual-0.4-0:arm64 libvo-aacenc0:arm64 libvo-amrwbenc0:arm64 libvorbis0a:arm64 libvorbisenc2:arm64 libvorbisfile3:arm64 libvpx6:arm64 libvtk6.3 libvulkan1:arm64 libwacom-bin libwacom-common libwacom2:arm64 libwavpack1:arm64 libwayland-client0:arm64 libwayland-cursor0:arm64 libwayland-egl1:arm64 libwayland-server0:arm64 libwebp6:arm64 libwebpmux3:arm64 libwebrtc-audio-processing1:arm64 libwildmidi2:arm64 libwind0-heimdal:arm64 libwrap0:arm64 libx11-6:arm64 libx11-data libx11-dev:arm64 libx11-xcb-dev:arm64 libx11-xcb1:arm64 libx264-155:arm64 libx265-179:arm64 libxau-dev:arm64 libxau6:arm64 libxaw7:arm64 libxcb-dri2-0:arm64 libxcb-dri3-0:arm64 libxcb-glx0:arm64 libxcb-present0:arm64 libxcb-render0:arm64 libxcb-shape0:arm64 libxcb-shm0:arm64 libxcb-sync1:arm64 libxcb-xfixes0:arm64 libxcb1:arm64 libxcb1-dev:arm64 libxcomposite1:arm64 libxcursor1:arm64 libxdamage1:arm64 libxdmcp-dev:arm64 libxdmcp6:arm64 libxerces-c3.2:arm64 libxext6:arm64 libxfixes3:arm64 libxfont2:arm64 libxft2:arm64 libxi6:arm64 libxinerama1:arm64 libxkbcommon0:arm64 libxkbfile1:arm64 libxml2:arm64 libxmu6:arm64 libxmuu1:arm64 libxnvctrl0:arm64 libxpm4:arm64 libxrandr2:arm64 libxrender1:arm64 libxshmfence1:arm64 libxss1:arm64 libxt6:arm64 libxtables12:arm64 libxtst6:arm64 libxv1:arm64 libxvidcore4:arm64 libxxf86dga1:arm64 libxxf86vm1:arm64 libyaml-0-2:arm64 libzbar0:arm64 libzmq5:arm64 libzstd1:arm64 libzvbi-common libzvbi0:arm64 linux-libc-dev:arm64 locales login logrotate logsave lsb-base lsb-release man-db mawk mime-support mono-4.0-gac mono-gac mono-runtime mono-runtime-common mono-runtime-sgen mount mtd-utils mysql-common ncurses-base ncurses-bin net-tools netbase networkd-dispatcher numactl ocl-icd-libopencl1:arm64 odbcinst odbcinst1debian2:arm64 openssh-client openssh-server openssh-sftp-server openssl parted passwd pci.ids pciutils perl perl-base perl-modules-5.30 pinentry-curses pkg-config ppp procps proj-data python-apt-common python-atomicwrites python-attr python-configparser python-contextlib2 python-funcsigs python-importlib-metadata python-is-python3 python-more-itertools python-opengl python-packaging python-pathlib2 python-pexpect python-pkg-resources python-pluggy python-ptyprocess python-py python-pyparsing python-pytest python-scandir python-six python-wcwidth python-zipp python2 python2-minimal python2.7 python2.7-minimal python3 python3-apipkg python3-apport python3-apt python3-atomicwrites python3-attr python3-blinker python3-certifi python3-cffi-backend python3-chardet python3-crypto python3-cryptography python3-dbus python3-dbusmock python3-distro python3-distutils python3-entrypoints python3-execnet python3-gi python3-httplib2 python3-idna python3-importlib-metadata python3-jwt python3-keyring python3-launchpadlib python3-lazr.restfulclient python3-lazr.uri python3-lib2to3 python3-minimal python3-more-itertools python3-oauthlib python3-packaging python3-pkg-resources python3-pluggy python3-problem-report python3-py python3-pyparsing python3-pytest python3-pytest-forked python3-pytest-xdist python3-requests python3-requests-unixsocket python3-secretstorage python3-simplejson python3-six python3-systemd python3-urllib3 python3-wadllib python3-wcwidth python3-zipp python3.8 python3.8-minimal qemu-efi qemu-efi-aarch64 readline-common resolvconf rfkill rsync rsyslog sed sensible-utils shared-mime-info sound-theme-freedesktop sox sshfs sudo systemd systemd-sysv systemd-timesyncd sysvinit-utils tar timgm6mb-soundfont tzdata ubuntu-keyring ubuntu-mono ucf udev util-linux uuid-dev:arm64 vim vim-common vim-runtime vulkan-tools vulkan-utils wget wireless-tools wpasupplicant x11-apps x11-common x11-utils x11-xkb-utils x11-xserver-utils x11proto-core-dev x11proto-dev xauth xbitmaps xdg-desktop-portal xdg-user-dirs xfonts-base xfonts-encodings xfonts-utils xinit xkb-data xorg-sgml-doctools xserver-common xserver-xorg xserver-xorg-core xserver-xorg-input-all xserver-xorg-input-libinput xserver-xorg-input-wacom xserver-xorg-legacy xserver-xorg-video-all xserver-xorg-video-amdgpu xserver-xorg-video-ati xserver-xorg-video-fbdev xserver-xorg-video-nouveau xserver-xorg-video-radeon xserver-xorg-video-vesa xterm xtrans-dev xxd zlib1g:arm64 zlib1g-dev:arm64
chroot . sync
chroot . apt-get clean
chroot . sync


echo "Unmounting rootfs"
umount ./sys
umount ./proc
umount ./dev/pts
umount ./dev


echo "Removing conflicting and unnecessary files"
rm usr/bin/qemu-aarch64-static
rm -rf var/lib/apt/lists/*
rm -rf dev/*
rm -rf var/log/*
rm -rf var/cache/apt/archives/*.deb
rm -rf var/tmp/*
rm -rf tmp/*


echo "Applying binary patches"
cd ..
./apply_binaries.sh


echo "Adding ${JETSON_USR} as user"
cd tools
./l4t_create_default_user.sh -u ${JETSON_USR} -p ${JETSON_PWD} -n ${JETSON_NAME} --autologin --accept-license


echo "Creating image"
./jetson-disk-image-creator.sh -o ../../jetson_image.img -b jetson-nano -r 300